# Upstreams (localhost-only)
OLLAMA_BASE_URL=http://127.0.0.1:11434
MLX_BASE_URL=http://127.0.0.1:10240/v1

# Gateway listen
# SAFE DEFAULT: bind to loopback only.
# If you need LAN access, set GATEWAY_HOST=0.0.0.0 AND set a restrictive IP_ALLOWLIST.
# Never expose the gateway directly to the public Internet.
GATEWAY_HOST=127.0.0.1
GATEWAY_PORT=8800

# Auth (required). Generate a long random token.
GATEWAY_BEARER_TOKEN=REPLACE_ME

# Optional: accept multiple bearer tokens (comma-separated). If set, any token in the list is accepted.
# If empty, gateway falls back to single-token GATEWAY_BEARER_TOKEN.
# GATEWAY_BEARER_TOKENS=token_for_you,token_for_associate
GATEWAY_BEARER_TOKENS=

# Optional: per-token policy JSON (single-line JSON). Keys are bearer tokens.
# Supported keys (best-effort):
#   - tools_allowlist: "noop,http_fetch" (overrides all other tool toggles for that token)
#   - tools_allow_shell/tools_allow_fs/tools_allow_http_fetch/tools_allow_git: true|false
#   - tools_allow_system_info/tools_allow_models_refresh: true|false
#   - tools_rate_limit_rps/tools_rate_limit_burst
#   - max_request_bytes: integer (overrides MAX_REQUEST_BYTES for that token)
#   - ip_allowlist: "127.0.0.1,10.0.0.0/8" (overrides IP_ALLOWLIST for that token)
# Example:
# GATEWAY_TOKEN_POLICIES_JSON={"token_for_associate":{"tools_allowlist":"noop,http_fetch_local","tools_rate_limit_rps":2,"tools_rate_limit_burst":4}}
GATEWAY_TOKEN_POLICIES_JSON=

# If true and GATEWAY_TOKEN_POLICIES_JSON is set but invalid JSON, fail closed (HTTP 500)
# rather than silently ignoring policies.
# Recommended for production.
GATEWAY_TOKEN_POLICIES_STRICT=true

# Optional request guardrails
# MAX_REQUEST_BYTES=0 disables. When enabled, requests exceeding this size return 413.
MAX_REQUEST_BYTES=1000000

# Optional: allow only specific client IPs/CIDRs (comma-separated). Empty allows all.
# IP_ALLOWLIST=127.0.0.1,10.0.0.0/8
# SAFE DEFAULT: allow local machine only.
IP_ALLOWLIST=127.0.0.1

# Images (optional)
#
# The gateway supports a mock images backend by default.
# Standard setup: proxy to the InvokeAI OpenAI Images shim running on ada2:
# IMAGES_BACKEND=http_openai_images
# IMAGES_HTTP_BASE_URL=http://ada2:7860
#
# Optional default model string sent to the shim when the request omits `model`.
# If you configure SHIM_MODEL_PRESETS_JSON on ada2, this can be an alias like gpu_slow.
# IMAGES_OPENAI_MODEL=gpu_slow

# Routing policy
DEFAULT_BACKEND=ollama   # ollama|mlx

# If true, enable heuristic routing (tools/long-context/fast tier selection).
# If false, routing is strictly alias/prefix/explicit-model driven.
ROUTER_ENABLE_POLICY=true

# Backends can each have "strong" and "fast" model choices.
# These are used both by router policy and by the default alias registry.
OLLAMA_MODEL_STRONG=llama3.3:70b
OLLAMA_MODEL_FAST=qwen2.5:7b
MLX_MODEL_STRONG=mlx-community/gemma-2-2b-it-8bit
MLX_MODEL_FAST=mlx-community/gemma-2-2b-it-8bit

# Legacy aliases kept for backward compatibility
OLLAMA_MODEL_DEFAULT=llama3.3:70b
MLX_MODEL_DEFAULT=mlx-community/gemma-2-2b-it-8bit

# Tooling (gateway-level)
# SAFE DEFAULT: keep high-privilege tools disabled.
# Enabling shell/fs tools increases the blast radius if a token leaks.
TOOLS_ALLOW_SHELL=false
TOOLS_ALLOW_FS=false
TOOLS_SHELL_CWD=/var/lib/gateway/tools
TOOLS_SHELL_TIMEOUT_SEC=20

# Optional: safe built-in tools
TOOLS_ALLOW_SYSTEM_INFO=false
TOOLS_ALLOW_MODELS_REFRESH=false

# Optional explicit allowlist; if set, only these tools may be executed.
# Example: "noop,echo,followyourcanvas_generate,heartmula_generate"
TOOLS_ALLOWLIST=

# Tool bus JSONL log
TOOLS_LOG_PATH=/var/lib/gateway/data/tools/invocations.jsonl

# Tool bus logging mode:
# - ndjson: append-only JSONL at TOOLS_LOG_PATH
# - per_invocation: one JSON file per replay_id under TOOLS_LOG_DIR
# - both: do both
TOOLS_LOG_MODE=ndjson
TOOLS_LOG_DIR=/var/lib/gateway/data/tools

# Optional: explicit tool registry (versioned tool declarations executed via subprocess).
# See services/gateway/env/tools_registry.json.example
TOOLS_REGISTRY_PATH=/var/lib/gateway/app/tools_registry.json

# Optional: registry integrity check (sha256 hex). If set and mismatched, registry is ignored.
TOOLS_REGISTRY_SHA256=

# Tool execution hard limits
TOOLS_MAX_CONCURRENT=8
TOOLS_CONCURRENCY_TIMEOUT_SEC=5
TOOLS_SUBPROCESS_STDOUT_MAX_CHARS=20000
TOOLS_SUBPROCESS_STDERR_MAX_CHARS=20000

# Optional: per-bearer-token rate limiting for /v1/tools endpoints (disabled when <= 0).
TOOLS_RATE_LIMIT_RPS=0
TOOLS_RATE_LIMIT_BURST=0

# Optional: metrics endpoint
# SAFE DEFAULT: off (even though bearer-protected).
METRICS_ENABLED=false

# Embeddings
EMBEDDINGS_BACKEND=ollama   # ollama|mlx
EMBEDDINGS_MODEL=nomic-embed-text

# Memory
MEMORY_ENABLED=true
MEMORY_DB_PATH=/var/lib/gateway/data/memory.sqlite
MEMORY_TOP_K=6
MEMORY_MIN_SIM=0.25
MEMORY_MAX_CHARS=6000

# Minimal request instrumentation (JSONL)
# SAFE DEFAULT: off (logs may include sensitive prompt content).
REQUEST_LOG_ENABLED=false
REQUEST_LOG_PATH=/var/lib/gateway/data/requests.jsonl

